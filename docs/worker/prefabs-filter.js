"use strict";(()=>{function P(){return new Promise(r=>requestAnimationFrame(r))}function g(r){console.error(r)}async function x(r){return await(await fetch(r)).json()}function L(r){let e=[];return()=>{switch(e.length){case 0:{let t=(async()=>{await r(),e.shift()})();return e.push(t),t}case 1:{let t=e[0],s=(async()=>{await t,await P(),await r(),e.shift()})();return e.push(s),s}case 2:return e[1];default:throw Error(`Unexpected state: promiceses=${e.length.toString()}`)}}}var k={en:"english",de:"german",es:"spanish",fr:"french",it:"italian",ja:"japanese",ko:"koreana",pl:"polish",pt:"brazilian",ru:"russian",tr:"turkish","zh-CN":"schinese","zh-TW":"tchinese"},l=class r{static DEFAULT_LANGUAGE="english";baseUrl;defaultBlocks;defaultPrefabs;#t;#e;#r;constructor(e,t){this.baseUrl=e,this.#t=v(t),this.defaultBlocks=this.fetchLabelMap(r.DEFAULT_LANGUAGE,"blocks.json"),this.defaultPrefabs=this.fetchLabelMap(r.DEFAULT_LANGUAGE,"prefabs.json"),this.#e=this.buildLabels(this.defaultBlocks,"blocks.json"),this.#r=this.buildLabels(this.defaultPrefabs,"prefabs.json")}get blocks(){return this.#e}get prefabs(){return this.#r}set language(e){e!==this.#t&&(console.log("LabelHolder set language: %s -> %s",this.#t,e),this.#t=e,this.#e=this.buildLabels(this.defaultBlocks,"blocks.json"),this.#r=this.buildLabels(this.defaultPrefabs,"prefabs.json"))}async buildLabels(e,t){return new d(await this.fetchLabelMap(this.#t,t),await e)}async fetchLabelMap(e,t){return new Map(Object.entries(await E(`${this.baseUrl}/${e}/${t}`)))}},d=class{labels;defaultLabels;constructor(e,t){this.labels=e,this.defaultLabels=t}get(e){return this.labels.get(e)??this.defaultLabels.get(e)}};function v(r){for(let e of r)for(let[t,s]of Object.entries(k))if(e.startsWith(t))return s;return l.DEFAULT_LANGUAGE}async function E(r){return(await fetch(r)).json()}var c=class{all=[];filtered=[];markCoords=null;status="";#t={};#e;filter;throttledUpdater=L(()=>this.updateImmediately());updateListeners=[];constructor(e,t){this.#e=new l(e,t),this.filter=this.defaultMatcher()}set language(e){this.#e.language=e}set prefabsFilterString(e){let t=e.trim();t.length===0?this.filter=this.defaultMatcher():this.filter=new p(new RegExp(t,"i"),this.#e)}set blocksFilterString(e){let t=e.trim();t.length===0?this.filter=this.defaultMatcher():this.filter=new h(new RegExp(t,"i"),this.#t,this.#e)}set blockPrefabIndex(e){this.#t=e,this.filter instanceof h&&(this.filter=new h(this.filter.regexp,e,this.#e))}update(){this.throttledUpdater().catch(g)}async updateImmediately(){await this.applyFilter(),this.updateDist(),this.sort();let e={status:this.status,prefabs:this.filtered};this.updateListeners.forEach(t=>{t(e)})}addUpdateListener(e){this.updateListeners.push(e)}defaultMatcher(){return new b(this.#e)}async applyFilter(){let e=await this.filter.match(this.all);this.status=e.status,this.filtered=e.matched}updateDist(){if(this.markCoords){let{markCoords:e}=this;this.filtered.forEach(t=>t.dist=T(t,e))}else this.filtered.forEach(e=>e.dist=null)}sort(){this.markCoords?(this.status=`${this.status}, order by distances from the flag`,this.filtered.sort(M)):this.filtered.sort(m)}};function m(r,e){return r.name>e.name?1:r.name<e.name?-1:0}function M(r,e){return!r.dist||!e.dist?m(r,e):r.dist>e.dist?1:r.dist<e.dist?-1:m(r,e)}function T(r,e){return Math.round(Math.sqrt((r.x-e.x)**2+(r.z-e.z)**2))}function u(r,e){let t=!1,s=r.replace(e,a=>(t=a.length>0,`<mark>${a}</mark>`));return t?s:null}var b=class{labels;constructor(e){this.labels=e}async match(e){let t=await this.labels.prefabs;return{status:e.length===0?"No prefabs":"All prefabs",matched:e.map(s=>{let a=t.get(s.name)??"-";return{...s,highlightedName:s.name,highlightedLabel:a}})}}},p=class{regexp;labels;constructor(e,t){this.regexp=e,this.labels=t}async match(e){let t=await this.labels.prefabs,s=e.flatMap(a=>{let o=u(a.name,this.regexp),n=t.get(a.name)??"-",i=n&&u(n,this.regexp);return o??i?{...a,highlightedName:o??a.name,highlightedLabel:i??n}:[]});return{status:`${s.length.toString()} matched prefabs`,matched:s}}},h=class{regexp;blockPrefabIndex;labels;constructor(e,t,s){this.regexp=e,this.blockPrefabIndex=t,this.labels=s}async match(e){let t=await this.matchBlocks();if(t.length===0)return{status:"No matched blocks",matched:[]};let s=this.matchPrefabTypes(t);if(Object.keys(s).length===0)return{status:`No prefabs, but ${t.length.toString()} matched blocks`,matched:[]};let a=await this.labels.prefabs,o=e.flatMap(n=>{let i=s[n.name];return i?{...n,highlightedName:n.name,highlightedLabel:a.get(n.name)??"-",matchedBlocks:i}:[]});return{status:`${o.length.toString()} prefabs, ${t.length.toString()} matched blocks`,matched:o}}async matchBlocks(){let e=await this.labels.blocks;return Object.entries(this.blockPrefabIndex).reduce((t,[s,a])=>{let o=u(s,this.regexp),n=e.get(s)??"-",i=n&&u(n,this.regexp);return o??i?t.concat({name:s,highlightedName:o??s,highlightedLabel:i??n,prefabs:a}):t},[])}matchPrefabTypes(e){return e.reduce((t,s)=>{let{name:a,highlightedName:o,highlightedLabel:n}=s;return s.prefabs?.forEach(i=>{let w={name:a,highlightedName:o,highlightedLabel:n,count:i.count};t[i.name]=(t[i.name]??[]).concat(w)}),t},{})}};var f=new c("../labels",navigator.languages);(async()=>{f.blockPrefabIndex=await x("../block-prefab-index.json"),f.update()})().catch(g);onmessage=({data:r})=>{console.log("Prefab-filter received message: ",r),Object.assign(f,r).update()};f.addUpdateListener(r=>{console.log("Prefab-filter send message: ",r),postMessage(r)});})();
//# sourceMappingURL=prefabs-filter.js.map
