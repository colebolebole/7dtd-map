"use strict";(()=>{async function x(n){return new Promise(e=>setTimeout(e,n))}function c(n){console.error(n)}async function u(n){return await(await fetch(n)).json()}function w(n,e=100){let t=[];return()=>{switch(t.length){case 0:{let r=(async()=>{await n(),t.shift()})();return t.push(r),r}case 1:{let r=t[0],i=(async()=>{await r,await x(e),await n(),t.shift()})();return t.push(i),i}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length.toString()}`)}}}var y={en:"english",de:"german",es:"spanish",fr:"french",it:"italian",ja:"japanese",ko:"koreana",pl:"polish",pt:"brazilian",ru:"russian",tr:"turkish","zh-CN":"schinese","zh-TW":"tchinese"},k=["blocks","prefabs","shapes"],o=class n{static DEFAULT_LANGUAGE="english";#t;#e;#n;#r;constructor(e,t){this.#t=e,this.#e=v(t),this.#n=new Map(k.map(r=>[r,this.#s(n.DEFAULT_LANGUAGE,r)])),this.#r=this.#i()}get(e){let t=this.#r.get(e);if(!t)throw new Error(`No labels for ${this.#e}/${e}`);return t}set language(e){e!==this.#e&&(console.log("LabelHolder set language: %s -> %s",this.#e,e),this.#e=e,this.#r=this.#i())}#i(){return new Map(k.map(e=>[e,this.#a(e)]))}async#a(e){let t=this.#n.get(e);if(!t)throw new Error(`No fallback for ${this.#e}/${e}`);return new p(await this.#s(this.#e,e),await t)}async#s(e,t){return new Map(Object.entries(await u(`${this.#t}/${e}/${t}.json`)))}},p=class{#t;#e;constructor(e,t){this.#t=e,this.#e=t}get(e){return this.#t.get(e)??this.#e.get(e)}};function v(n){for(let e of n)for(let[t,r]of Object.entries(y))if(e.startsWith(t))return r;return o.DEFAULT_LANGUAGE}var l=class{#t;#e=[];#n="";all=[];markCoords=null;difficulty={start:0,end:5};prefabFilterRegexp="";blockFilterRegexp="";blockPrefabCounts={};throttledUpdater=w(()=>this.updateImmediately());updateListeners=[];constructor(e,t){this.#t=new o(e,t)}set language(e){this.#t.language=e}update(){this.throttledUpdater().catch(c)}async updateImmediately(){await this.#i(),this.#r(),this.#h(),this.#c();let e={status:this.#n,prefabs:this.#e};this.updateListeners.forEach(t=>{t(e)})}#r(){this.prefabFilterRegexp.length===0&&this.blockFilterRegexp.length===0&&this.difficulty.start===0&&this.difficulty.end===5?this.#n="All prefabs":this.#e.length===0?this.#n="No prefabs matched":this.#n=`${this.#e.length.toString()} prefabs matched`}addUpdateListener(e){this.updateListeners.push(e)}async#i(){let e=this.#a(this.all);e=await this.#s(e),e=await this.#o(e),this.#e=e}#a(e){return e.filter(t=>{let r=t.difficulty??0;return r>=this.difficulty.start&&r<=this.difficulty.end})}async#s(e){let t=await this.#t.get("prefabs");return e.flatMap(r=>{let i=t.get(r.name);if(this.prefabFilterRegexp.length===0)return{...r,highlightedName:r.name,highlightedLabel:i??"-"};let s=g(r.name,new RegExp(this.prefabFilterRegexp,"i")),a=i&&g(i,new RegExp(this.prefabFilterRegexp,"i"));return s!=null||a!=null?{...r,highlightedName:s??r.name,highlightedLabel:a??i??"-"}:[]})}async#o(e){if(this.blockFilterRegexp.length===0)return e;let t=await this.#l(e);return e.flatMap(r=>{let i=t[r.name];return i?{...r,matchedBlocks:i}:[]})}async#l(e){let t=await this.#t.get("blocks"),r=await this.#t.get("shapes"),i=new Set(e.map(a=>a.name)),s={};for(let[a,E]of Object.entries(this.blockPrefabCounts)){let b=g(a,new RegExp(this.blockFilterRegexp,"i")),d=t.get(a)??r.get(a)??"-",P=d&&g(d,new RegExp(this.blockFilterRegexp,"i"));if(!(b==null&&P==null))for(let[m,L]of Object.entries(E))i.has(m)&&(s[m]=(s[m]??[]).concat({name:a,highlightedName:b??a,highlightedLabel:P??d,count:L}))}return s}#h(){if(this.markCoords){let{markCoords:e}=this;this.#e.forEach(t=>t.dist=C(t,e))}else this.#e.forEach(e=>e.dist=null)}#c(){this.#e.length===0?this.#n+=". Please relax the filter conditions":this.markCoords?(this.#n+=", order by distances from the flag",this.#e.sort(M)):this.blockFilterRegexp.length>0?(this.#n+=", order by counts of matched blocks",this.#e.sort(N)):this.#e.sort(h)}};function h(n,e){return n.name>e.name?1:n.name<e.name?-1:0}function N(n,e){if(!n.matchedBlocks||!e.matchedBlocks)return h(n,e);let t=n.matchedBlocks.reduce((i,s)=>i+(s.count??0),0),r=e.matchedBlocks.reduce((i,s)=>i+(s.count??0),0);return t<r?1:t>r?-1:h(n,e)}function M(n,e){return!n.dist||!e.dist?h(n,e):n.dist>e.dist?1:n.dist<e.dist?-1:h(n,e)}function C(n,e){return Math.round(Math.sqrt((n.x-e.x)**2+(n.z-e.z)**2))}function g(n,e){let t=!1,r=n.replace(e,i=>(t=i.length>0,`<mark>${i}</mark>`));return t?r:null}var f=new l("../labels",navigator.languages);(async()=>{f.blockPrefabCounts=T(await u("../prefab-block-counts.json")),f.update()})().catch(c);onmessage=({data:n})=>{console.log("Prefab-filter received message: ",n),Object.assign(f,n).update()};f.addUpdateListener(n=>{console.log("Prefab-filter send message: ",n),postMessage(n)});function T(n){let e={};for(let[t,r]of Object.entries(n))for(let[i,s]of Object.entries(r))e[i]=Object.assign(e[i]??{},{[t]:s});return e}})();
//# sourceMappingURL=prefabs-filter.js.map
