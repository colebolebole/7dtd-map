(()=>{"use strict";var e={273:function(e,t){var a,s,r,i=this&&this.__classPrivateFieldSet||function(e,t,a,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,a):r?r.value=a:t.set(e,a),a},n=this&&this.__classPrivateFieldGet||function(e,t,a,s){if("a"===a&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===a?s:"a"===a?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.resolveLanguage=t.Labels=t.LabelHolder=t.LANGUAGES=void 0,t.LANGUAGES=["english","german","spanish","french","italian","japanese","koreana","polish","brazilian","russian","turkish","schinese","tchinese"];const o={en:"english",de:"german",es:"spanish",fr:"french",it:"italian",ja:"japanese",ko:"koreana",pl:"polish",pt:"brazilian",ru:"russian",tr:"turkish","zh-CN":"schinese","zh-TW":"tchinese"};class h{constructor(e,t){a.set(this,void 0),s.set(this,void 0),r.set(this,void 0),this.baseUrl=e,i(this,a,c(t),"f"),this.defaultBlocks=this.fetchLabelMap(h.DEFAULT_LANGUAGE,"blocks.json"),this.defaultPrefabs=this.fetchLabelMap(h.DEFAULT_LANGUAGE,"prefabs.json"),i(this,s,this.buildLabels(this.defaultBlocks,"blocks.json"),"f"),i(this,r,this.buildLabels(this.defaultPrefabs,"prefabs.json"),"f")}get blocks(){return n(this,s,"f")}get prefabs(){return n(this,r,"f")}set language(e){e!==n(this,a,"f")&&(console.log("LabelHolder set language: %s -> %s",n(this,a,"f"),e),i(this,a,e,"f"),i(this,s,this.buildLabels(this.defaultBlocks,"blocks.json"),"f"),i(this,r,this.buildLabels(this.defaultPrefabs,"prefabs.json"),"f"))}async buildLabels(e,t){return new l(await this.fetchLabelMap(n(this,a,"f"),t),await e)}async fetchLabelMap(e,t){return new Map(Object.entries(await async function(e){return(await fetch(e)).json()}(`${this.baseUrl}/${e}/${t}`)))}}t.LabelHolder=h,a=new WeakMap,s=new WeakMap,r=new WeakMap,h.DEFAULT_LANGUAGE="english";class l{constructor(e,t){this.labels=e,this.defaultLabels=t}get(e){return this.labels.get(e)??this.defaultLabels.get(e)}}function c(e){for(const t of e)for(const[e,a]of Object.entries(o))if(t.startsWith(e))return a;return h.DEFAULT_LANGUAGE}t.Labels=l,t.resolveLanguage=c},17:function(e,t,a){var s,r,i=this&&this.__classPrivateFieldSet||function(e,t,a,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,a):r?r.value=a:t.set(e,a),a},n=this&&this.__classPrivateFieldGet||function(e,t,a,s){if("a"===a&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===a?s:"a"===a?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0});const o=a(847),h=a(273);function l(e,t){return e.name>t.name?1:e.name<t.name?-1:0}function c(e,t){return e.dist&&t.dist?e.dist>t.dist?1:e.dist<t.dist?-1:l(e,t):l(e,t)}function u(e,t){let a=!1;const s=e.replace(t,(e=>(a=e.length>0,`<mark>${e}</mark>`)));return a?s:null}s=new WeakMap,r=new WeakMap,t.default=class{constructor(e,t){this.all=[],this.filtered=[],this.markCoords=null,this.status="",s.set(this,{}),r.set(this,void 0),this.throttledUpdater=(0,o.throttledInvoker)((async()=>await this.updateImmediately())),this.updateListeners=[],i(this,r,new h.LabelHolder(e,t),"f"),this.filter=this.defaultMatcher()}set language(e){n(this,r,"f").language=e}set prefabsFilterString(e){const t=e.trim();0===t.length?this.filter=this.defaultMatcher():this.filter=new f(new RegExp(t,"i"),n(this,r,"f"))}set blocksFilterString(e){const t=e.trim();0===t.length?this.filter=this.defaultMatcher():this.filter=new m(new RegExp(t,"i"),n(this,s,"f"),n(this,r,"f"))}set blockPrefabIndex(e){i(this,s,e,"f"),this.filter instanceof m&&(this.filter=new m(this.filter.regexp,e,n(this,r,"f")))}update(){this.throttledUpdater()}async updateImmediately(){await this.applyFilter(),this.updateDist(),this.sort();const e={status:this.status,prefabs:this.filtered};this.updateListeners.forEach((t=>t(e)))}addUpdateListener(e){this.updateListeners.push(e)}defaultMatcher(){return new d(n(this,r,"f"))}async applyFilter(){const e=await this.filter.match(this.all);this.status=e.status,this.filtered=e.matched}updateDist(){if(this.markCoords){const{markCoords:e}=this;this.filtered.forEach((t=>{return t.dist=(a=t,s=e,Math.round(Math.sqrt((a.x-s.x)**2+(a.z-s.z)**2)));var a,s}))}else this.filtered.forEach((e=>e.dist=null))}sort(){this.markCoords?(this.status=`${this.status}, order by distances from the flag`,this.filtered.sort(c)):this.filtered.sort(l)}};class d{constructor(e){this.labels=e}async match(e){const t=await this.labels.prefabs;return{status:0===e.length?"No prefabs":"All prefabs",matched:e.map((e=>{const a=t.get(e.name)??"-";return{...e,highlightedName:e.name,highlightedLabel:a}}))}}}class f{constructor(e,t){this.regexp=e,this.labels=t}async match(e){const t=await this.labels.prefabs,a=e.flatMap((e=>{const a=u(e.name,this.regexp),s=t.get(e.name)??"-",r=s&&u(s,this.regexp);return a||r?{...e,highlightedName:a||e.name,highlightedLabel:r||s}:[]}));return{status:`${a.length} matched prefabs`,matched:a}}}class m{constructor(e,t,a){this.regexp=e,this.blockPrefabIndex=t,this.labels=a}async match(e){const t=await this.matchBlocks();if(0===t.length)return{status:"No matched blocks",matched:[]};const a=this.matchPrefabTypes(t);if(0===Object.keys(a).length)return{status:`No prefabs, but ${t.length} matched blocks`,matched:[]};const s=await this.labels.prefabs,r=e.flatMap((e=>{const t=a[e.name];return t?{...e,highlightedName:e.name,highlightedLabel:s.get(e.name)??"-",matchedBlocks:t}:[]}));return{status:`${r.length} prefabs, ${t.length} matched blocks`,matched:r}}async matchBlocks(){const e=await this.labels.blocks;return Object.entries(this.blockPrefabIndex).reduce(((t,[a,s])=>{const r=u(a,this.regexp),i=e.get(a)??"-",n=i&&u(i,this.regexp);return r||n?t.concat({name:a,highlightedName:r||a,highlightedLabel:n||i,prefabs:s}):t}),[])}matchPrefabTypes(e){return e.reduce(((e,t)=>{const{name:a,highlightedName:s,highlightedLabel:r}=t;return t.prefabs?.forEach((t=>{const i={name:a,highlightedName:s,highlightedLabel:r,count:t.count};e[t.name]=(e[t.name]||[]).concat(i)})),e}),{})}}},847:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.throttledInvoker=void 0;const s=a(726);t.throttledInvoker=function(e){const t=[];return()=>{switch(t.length){case 0:return t.push((async()=>{await e(),t.shift()})()),t[0];case 1:{const a=t[0];return t.push((async()=>{await a,await(0,s.waitAnimationFrame)(),await e(),t.shift()})()),t[1]}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length}`)}}}},726:(e,t)=>{function a(e,t=(()=>`Unexpected state: ${e}`)){if(null!=e)return e;throw Error(t())}function s(e,t,a=(()=>`Unexpected type: ${e}`)){if(e instanceof t)return e;throw Error(a())}function r(e){return{type:"game",...e}}function i(e,t,a){const s=e.offsetX*t.width/a.width,i=e.offsetY*t.height/a.height;if(s<0||s>=t.width||i<0||i>=t.height)return null;const n=s-Math.floor(t.width/2),o=Math.floor(t.height/2)-i;return r({x:Math.round(n),z:Math.round(o)})}Object.defineProperty(t,"__esModule",{value:!0}),t.threePlaneSize=t.canvasEventToGameCoords=t.gameCoords=t.gameMapSize=t.sleep=t.imageBitmapToPngBlob=t.downloadCanvasPng=t.formatCoords=t.waitAnimationFrame=t.humanreadableDistance=t.removeAllChildren=t.component=t.requireType=t.requireNonnull=void 0,t.requireNonnull=a,t.requireType=s,t.component=function(e,t){const r=a(document.getElementById(a(e,(()=>`Element ID must not null: ${e}`))),(()=>`Element not found: #${e}`));return t?s(r,t):r},t.removeAllChildren=function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},t.humanreadableDistance=function(e){return e<1e3?`${e}m`:`${(e/1e3).toFixed(2)}km`},t.waitAnimationFrame=function(){return new Promise((e=>requestAnimationFrame(e)))},t.formatCoords=function(e,t,a,s){if(!s)return"E/W: -, N/S: -, Elev: -";const r=i(s,e,t);if(null===r)return"E/W: -, N/S: -, Elev: -";const n=a(r,e)??"-";return`E/W: ${r.x}, N/S: ${r.z}, Elev: ${n}`},t.downloadCanvasPng=function(e,t){const a=document.createElement("a");a.download=e,a.href=t.toDataURL("image/png"),a.click()},t.imageBitmapToPngBlob=async function(e){const t=new OffscreenCanvas(e.height,e.width);return a(t.getContext("2d")).drawImage(e,0,0),await t.convertToBlob({type:"image/png"})},t.sleep=async function(e){return new Promise((t=>setTimeout(t,e)))},t.gameMapSize=function(e){return{type:"game",...e}},t.gameCoords=r,t.canvasEventToGameCoords=i,t.threePlaneSize=function(e,t){return{type:"threePlane",width:e,height:t}}},770:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=new(s(a(17)).default)("../labels",navigator.languages);(async()=>{r.blockPrefabIndex=await async function(e){return(await fetch("../block-prefab-index.json")).json()}(),r.update()})(),onmessage=({data:e})=>{console.log("Prefab-filter received message: ",e),Object.assign(r,e).update()},r.addUpdateListener((e=>{console.log("Prefab-filter send message: ",e),postMessage(e)}))}},t={};!function a(s){var r=t[s];if(void 0!==r)return r.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,a),i.exports}(770)})();
//# sourceMappingURL=prefabs-filter.js.map