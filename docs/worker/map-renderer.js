"use strict";(()=>{function c(a,e=()=>`Unexpected state: ${String(a)}`){if(a==null)throw Error(e());return a}var x=0;async function f(a){let e=x++;console.time(`imageBitmapToPngBlob ${e.toString()}`);let t=new OffscreenCanvas(a.height,a.width);c(t.getContext("2d")).drawImage(a,0,0);let i=await t.convertToBlob({type:"image/png"});return console.timeEnd(`imageBitmapToPngBlob ${e.toString()}`),console.debug("imageBitmapToPngBlob png %d KB",i.size/1e3),i}async function d(a){return new Promise(e=>setTimeout(e,a))}function b(a){return{type:"game",...a}}function w(a){console.error(a)}var B=1e4,s=class{label;_png;img;fallbackPromise=null;lastAccessAt=0;imgAge;constructor(e,t,n=B){this.label=e,A(t)?this._png=t:(this._png=f(t),this.setImg(t)),this.imgAge=n}async get(){return this.lastAccessAt=Date.now(),this.img??this.fallbackPromise??this.getFallback()}async getFallback(){return this.fallbackPromise=this.getImageBitmap(),this.fallbackPromise}async getImageBitmap(){console.debug("Fallback",this.label);let e=await createImageBitmap(await this._png);return this.setImg(e),this.fallbackPromise=null,e}setImg(e){this.img=e,setTimeout(()=>{this.expireImage()},this.imgAge)}expireImage(){Date.now()-this.lastAccessAt>this.imgAge?(console.debug("Expire",this.label),c(this.img).close(),this.img=null):setTimeout(()=>{this.expireImage()},this.imgAge)}};function A(a){return a instanceof Blob}function I(a,e=100){let t=[];return()=>{switch(t.length){case 0:{let n=(async()=>{try{await a()}finally{t.shift()}})();return t.push(n),n}case 1:{let n=t[0],i=(async()=>{await n,await d(e);try{await a()}finally{t.shift()}})();return t.push(i),i}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length.toString()}`)}}}var S="\u2718",M="\u{1F6A9}\uFE0F",r=class{brightness="100%";markerCoords=null;scale=.1;showPrefabs=!0;prefabs=[];signSize=200;signAlpha=1;biomesAlpha=1;splat3Alpha=1;splat4Alpha=1;radAlpha=1;canvas;update=I(async()=>{console.time("MapUpdate"),await this.updateImmediately(),console.timeEnd("MapUpdate")});_biomesImg=null;_splat3Img=null;_splat4Img=null;_radImg=null;fontFace;constructor(e,t){this.canvas=e,this.fontFace=t}set biomesImg(e){this._biomesImg=e?new s("biomes",e):null}set splat3Img(e){this._splat3Img=e?new s("splat3",e):null}set splat4Img(e){this._splat4Img=e?new s("splat4",e):null}set radImg(e){this._radImg=e?new s("rad",e):null}async size(){let e=await Promise.all([this._biomesImg?.get(),this._splat3Img?.get(),this._splat4Img?.get()]);return b({width:Math.max(...e.map(t=>t?.width??0)),height:Math.max(...e.map(t=>t?.height??0))})}isBlank(){return!this._biomesImg&&!this._splat3Img&&!this._splat4Img}async updateImmediately(){if(this.isBlank()){this.canvas.width=1,this.canvas.height=1;return}let{width:e,height:t}=await this.size();this.canvas.width=e*this.scale,this.canvas.height=t*this.scale;let n=this.canvas.getContext("2d");n&&(n.scale(this.scale,this.scale),n.filter=`brightness(${this.brightness})`,this._biomesImg&&this.biomesAlpha!==0&&(n.globalAlpha=this.biomesAlpha,n.drawImage(await this._biomesImg.get(),0,0,e,t)),this._splat3Img&&this.splat3Alpha!==0&&(n.globalAlpha=this.splat3Alpha,n.drawImage(await this._splat3Img.get(),0,0,e,t)),this._splat4Img&&this.splat4Alpha!==0&&(n.globalAlpha=this.splat4Alpha,n.drawImage(await this._splat4Img.get(),0,0,e,t)),n.filter="none",this._radImg&&this.radAlpha!==0&&(n.globalAlpha=this.radAlpha,n.imageSmoothingEnabled=!1,n.drawImage(await this._radImg.get(),0,0,e,t),n.imageSmoothingEnabled=!0),n.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(n,e,t),this.markerCoords&&this.drawMark(n,e,t))}drawPrefabs(e,t,n){e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="center",e.textBaseline="middle";let i=t/2,m=n/2,g=Math.round(this.signSize*.01),h=Math.round(this.signSize*.05);for(let l of this.prefabs.toReversed()){let p=i+l.x+g,P=m-l.z+h;v(e,{text:S,x:p,z:P,size:this.signSize})}}drawMark(e,t,n){if(!this.markerCoords)return;e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="left",e.textBaseline="alphabetic";let i=t/2,m=n/2,g=-1*Math.round(this.signSize*.32),h=-1*Math.round(this.signSize*.1),l=i+this.markerCoords.x+g,p=m-this.markerCoords.z+h;v(e,{text:M,x:l,z:p,size:this.signSize})}};function v(a,{text:e,x:t,z:n,size:i}){a.lineWidth=Math.round(i*.2),a.strokeStyle="rgba(0, 0, 0, 0.8)",a.strokeText(e,t,n),a.lineWidth=Math.round(i*.1),a.strokeStyle="white",a.strokeText(e,t,n),a.fillText(e,t,n)}var u=new FontFace("Noto Sans","url(../NotoEmoji-Regular.ttf)"),o=null;u.load().then(()=>(fonts.add(u),o?.update())).catch(w);onmessage=async a=>{let e=a.data;if(console.debug(e),!o)if(e.canvas)o=new r(e.canvas,u);else throw Error("Unexpected state");await Object.assign(o,e).update(),postMessage({mapSize:await o.size()})};})();
//# sourceMappingURL=map-renderer.js.map
