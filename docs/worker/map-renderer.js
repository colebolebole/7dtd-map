"use strict";(()=>{function u(n,e=()=>`Unexpected state: ${String(n)}`){if(n==null)throw Error(e());return n}async function f(n){let e=new OffscreenCanvas(n.height,n.width);return u(e.getContext("2d")).drawImage(n,0,0),await e.convertToBlob({type:"image/png"})}async function d(n){return new Promise(e=>setTimeout(e,n))}function b(n){return{type:"game",...n}}function w(n){console.error(n)}var P=1e4,i=class{label;_png;img;fallbackPromise=null;lastAccessAt=0;imgAge;constructor(e,t,a=P){this.label=e,A(t)?this._png=t:(this._png=f(t),this.setImg(t)),this.imgAge=a}async get(){return this.lastAccessAt=Date.now(),this.img??this.fallbackPromise??this.getFallback()}async getFallback(){return this.fallbackPromise=this.getImageBitmap(),this.fallbackPromise}async getImageBitmap(){console.debug("Fallback",this.label);let e=await createImageBitmap(await this._png);return this.setImg(e),this.fallbackPromise=null,e}setImg(e){this.img=e,setTimeout(()=>{this.expireImage()},this.imgAge)}expireImage(){Date.now()-this.lastAccessAt>this.imgAge?(console.debug("Expire",this.label),u(this.img).close(),this.img=null):setTimeout(()=>{this.expireImage()},this.imgAge)}};function A(n){return n instanceof Blob}function I(n,e=100){let t=[];return()=>{switch(t.length){case 0:{let a=(async()=>{await n(),t.shift()})();return t.push(a),a}case 1:{let a=t[0],s=(async()=>{await a,await d(e),await n(),t.shift()})();return t.push(s),s}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length.toString()}`)}}}var M="\u2718",S="\u{1F6A9}\uFE0F",r=class{brightness="100%";markerCoords=null;scale=.1;showPrefabs=!0;prefabs=[];signSize=200;signAlpha=1;biomesAlpha=1;splat3Alpha=1;splat4Alpha=1;radAlpha=1;canvas;update=I(async()=>{console.time("MapUpdate"),await this.updateImmediately(),console.timeEnd("MapUpdate")});_biomesImg=null;_splat3Img=null;_splat4Img=null;_radImg=null;fontFace;constructor(e,t){this.canvas=e,this.fontFace=t}set biomesImg(e){this._biomesImg=e?new i("biomes",e):null}set splat3Img(e){this._splat3Img=e?new i("splat3",e):null}set splat4Img(e){this._splat4Img=e?new i("splat4",e):null}set radImg(e){this._radImg=e?new i("rad",e):null}async size(){let e=await Promise.all([this._biomesImg?.get(),this._splat3Img?.get(),this._splat4Img?.get()]);return b({width:Math.max(...e.map(t=>t?.width??0)),height:Math.max(...e.map(t=>t?.height??0))})}isBlank(){return!this._biomesImg&&!this._splat3Img&&!this._splat4Img}async updateImmediately(){if(this.isBlank()){this.canvas.width=1,this.canvas.height=1;return}let{width:e,height:t}=await this.size();this.canvas.width=e*this.scale,this.canvas.height=t*this.scale;let a=this.canvas.getContext("2d");a&&(a.scale(this.scale,this.scale),a.filter=`brightness(${this.brightness})`,this._biomesImg&&this.biomesAlpha!==0&&(a.globalAlpha=this.biomesAlpha,a.drawImage(await this._biomesImg.get(),0,0,e,t)),this._splat3Img&&this.splat3Alpha!==0&&(a.globalAlpha=this.splat3Alpha,a.drawImage(await this._splat3Img.get(),0,0,e,t)),this._splat4Img&&this.splat4Alpha!==0&&(a.globalAlpha=this.splat4Alpha,a.drawImage(await this._splat4Img.get(),0,0,e,t)),a.filter="none",this._radImg&&this.radAlpha!==0&&(a.globalAlpha=this.radAlpha,a.imageSmoothingEnabled=!1,a.drawImage(await this._radImg.get(),0,0,e,t),a.imageSmoothingEnabled=!0),a.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(a,e,t),this.markerCoords&&this.drawMark(a,e,t))}drawPrefabs(e,t,a){e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="center",e.textBaseline="middle";let s=t/2,m=a/2,h=Math.round(this.signSize*.01),g=Math.round(this.signSize*.05);for(let l of this.prefabs.toReversed()){let p=s+l.x+h,x=m-l.z+g;v(e,{text:M,x:p,z:x,size:this.signSize})}}drawMark(e,t,a){if(!this.markerCoords)return;e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="left",e.textBaseline="alphabetic";let s=t/2,m=a/2,h=-1*Math.round(this.signSize*.32),g=-1*Math.round(this.signSize*.1),l=s+this.markerCoords.x+h,p=m-this.markerCoords.z+g;v(e,{text:S,x:l,z:p,size:this.signSize})}};function v(n,{text:e,x:t,z:a,size:s}){n.lineWidth=Math.round(s*.2),n.strokeStyle="rgba(0, 0, 0, 0.8)",n.strokeText(e,t,a),n.lineWidth=Math.round(s*.1),n.strokeStyle="white",n.strokeText(e,t,a),n.fillText(e,t,a)}var c=new FontFace("Noto Sans","url(../NotoEmoji-Regular.ttf)"),o=null;c.load().then(()=>(fonts.add(c),o?.update())).catch(w);onmessage=async n=>{let e=n.data;if(console.debug(e),!o)if(e.canvas)o=new r(e.canvas,c);else throw Error("Unexpected state");await Object.assign(o,e).update(),postMessage({mapSize:await o.size()})};})();
//# sourceMappingURL=map-renderer.js.map
