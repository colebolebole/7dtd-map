"use strict";(()=>{function c(a,e=()=>`Unexpected state: ${String(a)}`){if(a!=null)return a;throw Error(e())}function d(){return new Promise(a=>requestAnimationFrame(a))}async function b(a){let e=new OffscreenCanvas(a.height,a.width);return c(e.getContext("2d")).drawImage(a,0,0),await e.convertToBlob({type:"image/png"})}function w(a){return{type:"game",...a}}function I(a){console.error(a)}var A=1e4,s=class{label;_png;img;fallbackPromise=null;lastAccessAt=0;imgAge;constructor(e,t,n=A){this.label=e,M(t)?this._png=t:(this._png=b(t),this.setImg(t)),this.imgAge=n}async get(){return this.lastAccessAt=Date.now(),this.img??this.fallbackPromise??this.getFallback()}async getFallback(){return this.fallbackPromise=this.getImageBitmap(),this.fallbackPromise}async getImageBitmap(){console.debug("Fallback",this.label);let e=await createImageBitmap(await this._png);return this.setImg(e),this.fallbackPromise=null,e}setImg(e){this.img=e,setTimeout(()=>{this.expireImage()},this.imgAge)}expireImage(){Date.now()-this.lastAccessAt>this.imgAge?(console.debug("Expire",this.label),c(this.img).close(),this.img=null):setTimeout(()=>{this.expireImage()},this.imgAge)}};function M(a){return a instanceof Blob}function v(a){let e=[];return()=>{switch(e.length){case 0:{let t=(async()=>{await a(),e.shift()})();return e.push(t),t}case 1:{let t=e[0],n=(async()=>{await t,await d(),await a(),e.shift()})();return e.push(n),n}case 2:return e[1];default:throw Error(`Unexpected state: promiceses=${e.length.toString()}`)}}}var S="\u2718",u="\u{1F6A9}\uFE0F",l=class{brightness="100%";markerCoords=null;scale=.1;showPrefabs=!0;prefabs=[];signSize=200;signAlpha=1;biomesAlpha=1;splat3Alpha=1;splat4Alpha=1;radAlpha=1;canvas;update=v(async()=>{console.time("MapUpdate"),await this.updateImmediately(),console.timeEnd("MapUpdate")});_biomesImg=null;_splat3Img=null;_splat4Img=null;_radImg=null;fontFace;constructor(e,t){this.canvas=e,this.fontFace=t}set biomesImg(e){this._biomesImg=e?new s("biomes",e):null}set splat3Img(e){this._splat3Img=e?new s("splat3",e):null}set splat4Img(e){this._splat4Img=e?new s("splat4",e):null}set radImg(e){this._radImg=e?new s("rad",e):null}async size(){let e=await Promise.all([this._biomesImg?.get(),this._splat3Img?.get(),this._splat4Img?.get()]);return w({width:Math.max(...e.map(t=>t?.width??0)),height:Math.max(...e.map(t=>t?.height??0))})}isBlank(){return!this._biomesImg&&!this._splat3Img&&!this._splat4Img}async updateImmediately(){if(this.isBlank()){this.canvas.width=1,this.canvas.height=1;return}let{width:e,height:t}=await this.size();this.canvas.width=e*this.scale,this.canvas.height=t*this.scale;let n=this.canvas.getContext("2d");n&&(n.scale(this.scale,this.scale),n.filter=`brightness(${this.brightness})`,this._biomesImg&&this.biomesAlpha!==0&&(n.globalAlpha=this.biomesAlpha,n.drawImage(await this._biomesImg.get(),0,0,e,t)),this._splat3Img&&this.splat3Alpha!==0&&(n.globalAlpha=this.splat3Alpha,n.drawImage(await this._splat3Img.get(),0,0,e,t)),this._splat4Img&&this.splat4Alpha!==0&&(n.globalAlpha=this.splat4Alpha,n.drawImage(await this._splat4Img.get(),0,0,e,t)),n.filter="none",this._radImg&&this.radAlpha!==0&&(n.globalAlpha=this.radAlpha,n.imageSmoothingEnabled=!1,n.drawImage(await this._radImg.get(),0,0,e,t),n.imageSmoothingEnabled=!0),n.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(n,e,t),this.markerCoords&&this.drawMark(n,e,t))}drawPrefabs(e,t,n){e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="center",e.textBaseline="middle";let i=t/2,h=n/2,g=Math.round(this.signSize*.01),p=Math.round(this.signSize*.05);for(let r of this.prefabs.toReversed()){let o=i+r.x+g,P=h-r.z+p;x(e,{text:S,x:o,z:P,size:this.signSize})}}drawMark(e,t,n){if(!this.markerCoords)return;e.font=`${this.signSize.toString()}px ${this.fontFace.family}`,e.fillStyle="red",e.textAlign="left",e.textBaseline="alphabetic";let i=t/2,h=n/2,g=-1*Math.round(this.signSize*.32),p=-1*Math.round(this.signSize*.1),r=i+this.markerCoords.x+g,o=h-this.markerCoords.z+p;x(e,{text:u,x:r,z:o,size:this.signSize}),e.strokeText(u,r,o),e.fillText(u,r,o)}};function x(a,{text:e,x:t,z:n,size:i}){a.lineWidth=Math.round(i*.2),a.strokeStyle="rgba(0, 0, 0, 0.8)",a.strokeText(e,t,n),a.lineWidth=Math.round(i*.1),a.strokeStyle="white",a.strokeText(e,t,n),a.fillText(e,t,n)}var f=new FontFace("Noto Sans","url(../NotoEmoji-Regular.ttf)"),m=null;f.load().then(()=>(fonts.add(f),m?.update())).catch(I);onmessage=async a=>{let e=a.data;if(console.debug(e),!m)if(e.canvas)m=new l(e.canvas,f);else throw Error("Unexpected state");await Object.assign(m,e).update(),postMessage({mapSize:await m.size()})};})();
//# sourceMappingURL=map-renderer.js.map
